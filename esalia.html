<html>
<head>
<script>
function getMobileOperatingSystem() {

  var userAgent = navigator.userAgent || navigator.vendor || window.opera;

  if( userAgent.match( /iPad/i ) || userAgent.match( /iPhone/i ) || userAgent.match( /iPod/i ) ){
    return 'iOS';
  }
  else if( userAgent.match( /Android/i ) ){
    return 'Android';
  }
  else{
    return 'unknown';
  }
};

var vis = (function(){
    var stateKey, 
        eventKey, 
        keys = {
                hidden: "visibilitychange",
                webkitHidden: "webkitvisibilitychange",
                mozHidden: "mozvisibilitychange",
                msHidden: "msvisibilitychange"
    };
    for (stateKey in keys) {
        if (stateKey in document) {
            eventKey = keys[stateKey];
            break;
        }
    }
    return function(c) {
        if (c) document.addEventListener(eventKey, c);
        return !document[stateKey];
    }
})();

var loadedAt;
var lostFocus;
function goToTheApp(){
	lostFocus = false;
	var typeDevice = getMobileOperatingSystem();
	var storeLink = "https://play.google.com/store/apps/details?id=not.a.packagename.sg";
	if(typeDevice == "iOS"){
		storeLink = "https://itunes.apple.com/fr/app/lappli-esalia/id444483284?mt=8";
	}
	
	var appUrlScheme = "essg://";
	
	//If the app is not installed the script will wait for 2sec and redirect to web.
	loadedAt = +new Date;
	setTimeout(
			   function(){
					if((+new Date - loadedAt < 3000) && vis()){
						//alert("focus:" + vis() + " deltaTime:" + (+new Date - loadedAt) );
					
						window.location = storeLink;
						window.close();
					}
			   }
			   ,2000);
	//Try launching the app using URL schemes
	//window.open(appUrlScheme,"_self");
	
	
};

var typDevice = getMobileOperatingSystem();
if(typDevice == "iOS" || typDevice =="Android"){
	
} else {
	window.location = "https://homologation-smartphone.s2e-net.com/New.Esalia";
}

// TODO Utiliser des Cookies pour ne pas toujours demander
// var smartCookie = utils_getCookie("smartBannerCookie");
// if (smartCookie == null){
/*
	var typDevice = getMobileOperatingSystem();
	
	if(typDevice == "iOS" || typDevice =="Android"){
		var storeLink = "https://play.google.com/store/apps/details?id=not.a.packagename.sg";
		if(typDevice == "iOS"){
			storeLink = "https://itunes.apple.com/fr/app/lappli-esalia/id444483284?mt=8";
		}
		
		var appUrlScheme = "essg://";
		
		//If the app is not installed the script will wait for 2sec and redirect to web.
        var loadedAt = +new Date;
        setTimeout(
                   function(){
                       if (+new Date - loadedAt < 2000){
							window.location = storeLink;
                       }
                   }
                   ,25);
        //Try launching the app using URL schemes
        window.open(appUrlScheme,"_self");	
	}*/
	
	/*
	if(typDevice == "Android"){
		var confirmation = confirm("Télécharger l'application Esalia");
		if (confirmation == true) {
			window.stop();
			// window.location="market://details?id=not.a.packagename.sg";
			window.location="https://play.google.com/store/apps/details?id=not.a.packagename.sg";
			// utils_setCookie("smartBannerCookie", "Android_ok", 2592000000, "/");
		}
		else {
			// utils_setCookie("smartBannerCookie", "Android_annul", 2592000000, "/");
			// window.location="https://homologation-smartphone.s2e-net.com/New.Esalia/";
		}
	}
	

    if (typDevice == "iOS")
    {
		var appstoreFail = "www.your_redirect_website.com";

		//Check is device is iOS
		//var iOS = (navigator.userAgent.match(/(iPad|iPhone|iPod)/g) ? true : false );
		var appUrlScheme = "xyz_app://";
        //If the app is not installed the script will wait for 2sec and redirect to web.
        var loadedAt = +new Date;
        setTimeout(
                   function(){
                       if (+new Date - loadedAt < 2000){
                   window.location = appstoreFail;
                       }
                   }
                   ,25);
        //Try launching the app using URL schemes
        window.open(appUrlScheme,"_self");
    } else {
        //Launch the website
        window.location = weblink;
    }*/
// }
</script>
</head>
<body>
<h1>
	Une application est disponible pour votre terminal, que souhaitez-vous faire ?<br/>
	<a onclick="goToTheApp()" href="essg://">Utiliser l'application</a><br/>
	<a href="https://homologation-smartphone.s2e-net.com/New.Esalia">Utliser le site web</a>
</h1>
</body>
</html>